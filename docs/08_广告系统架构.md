# 📖 广告系统架构

> 技术框架与核心组件

---

## 🎯 广告系统概述

### **广告系统的核心挑战**

| 挑战 | 说明 |
|-----|------|
| **高并发** | 每秒数十万到数百万请求 |
| **低延迟** | 单次请求需要在100ms内响应 |
| **大数据** | 每天处理数十亿条日志 |
| **实时性** | 需要快速响应市场变化 |
| **准确性** | CTR预测、人群定向的精准度 |

---

## 🏗️ 整体架构

### **广告系统架构图**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           广告系统整体架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         在线服务层                                   │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐       │  │
│   │  │ 广告检索   │  │ CTR预估   │  │ 竞价排序   │  │ 创意选择   │       │  │
│   │  │  Server   │  │  Server   │  │  Server   │  │  Server   │       │  │
│   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         数据存储层                                   │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐       │  │
│   │  │ 广告索引   │  │ 用户画像   │  │ 特征缓存   │  │ 模型参数   │       │  │
│   │  │  (Redis)  │  │  (Redis)  │  │  (Redis)  │  │  (Redis)  │       │  │
│   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    ▲                                        │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         离线计算层                                   │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐       │  │
│   │  │ 用户画像   │  │ CTR模型   │  │ 报表统计   │  │ 日志处理   │       │  │
│   │  │  计算     │  │  训练     │  │           │  │           │       │  │
│   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘       │  │
│   │                        Hadoop / Spark                               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    ▲                                        │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         数据采集层                                   │  │
│   │  ┌───────────┐  ┌───────────┐  ┌───────────┐                       │  │
│   │  │ 展示日志   │  │ 点击日志   │  │ 转化日志   │                       │  │
│   │  │  Kafka    │  │  Kafka    │  │  Kafka    │                       │  │
│   │  └───────────┘  └───────────┘  └───────────┘                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ⚙️ 核心模块

### **1. 广告检索服务**

```
┌─────────────────────────────────────────────────────────────────┐
│                    广告检索流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   输入：广告请求（用户ID、广告位、上下文）                         │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   Step 1: 定向匹配                                              │
│           ├── 地域定向匹配                                       │
│           ├── 人群定向匹配                                       │
│           └── 频次控制                                          │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   Step 2: 召回候选                                              │
│           └── 从广告索引中检索符合条件的广告                      │
│           └── 通常返回100-1000个候选                             │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   Step 3: 粗排过滤                                              │
│           └── 简单模型快速过滤                                   │
│           └── 保留Top 50-100                                    │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   输出：候选广告列表                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### **2. CTR预估服务**

```
┌─────────────────────────────────────────────────────────────────┐
│                    CTR预估服务                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   输入：候选广告列表 + 用户特征 + 上下文特征                       │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   Step 1: 特征拼接                                              │
│           ├── 查询用户特征缓存                                   │
│           ├── 查询广告特征缓存                                   │
│           └── 构造交叉特征                                       │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   Step 2: 模型推理                                              │
│           └── 批量预测所有候选的CTR                              │
│           └── GPU/CPU推理                                       │
│                                                                 │
│         ▼                                                       │
│                                                                 │
│   输出：每个候选广告的预估CTR                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### **3. 竞价排序服务**

```
排序公式：

Score = f(CTR, bid, quality_score, ...)

常见的排序方式：

1. 简单eCPM排序
   Score = CTR × bid

2. 带质量因子
   Score = CTR × bid × quality_score

3. 多目标优化
   Score = α×CTR×bid + β×user_experience + γ×...
```

---

## 📊 数据流

### **在线数据流**

```
                    广告请求处理流程（~100ms）
                    
用户访问页面
     │
     ▼ (10ms)
┌──────────────┐
│   负载均衡    │
└──────┬───────┘
       │
       ▼ (5ms)
┌──────────────┐
│   广告检索    │◀─── 广告索引(Redis)
└──────┬───────┘
       │
       ▼ (20ms)
┌──────────────┐
│  用户特征查询  │◀─── 用户画像(Redis)
└──────┬───────┘
       │
       ▼ (30ms)
┌──────────────┐
│   CTR预估    │◀─── 模型参数(GPU)
└──────┬───────┘
       │
       ▼ (10ms)
┌──────────────┐
│   竞价排序    │
└──────┬───────┘
       │
       ▼ (5ms)
┌──────────────┐
│   创意选择    │
└──────┬───────┘
       │
       ▼
返回广告
```

### **离线数据流**

```
                    离线数据处理流程

展示/点击/转化日志
        │
        ▼
┌───────────────┐
│  Kafka 消息队列 │
└───────┬───────┘
        │
        ├─────────────────────────────────────┐
        │                                     │
        ▼                                     ▼
┌───────────────┐                    ┌───────────────┐
│  实时统计      │                    │  离线存储      │
│  (Flink/Storm)│                    │  (HDFS/Hive)  │
└───────┬───────┘                    └───────┬───────┘
        │                                     │
        ▼                                     ▼
┌───────────────┐                    ┌───────────────┐
│  实时报表      │                    │  批量计算      │
│  实时特征      │                    │  (Spark)      │
└───────────────┘                    └───────┬───────┘
                                             │
                         ┌───────────────────┼───────────────────┐
                         │                   │                   │
                         ▼                   ▼                   ▼
                 ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
                 │  用户画像      │  │  CTR模型训练   │  │  报表统计      │
                 └───────────────┘  └───────────────┘  └───────────────┘
```

---

## 🛠️ 关键技术组件

### **存储层**

| 组件 | 用途 | 特点 |
|-----|------|-----|
| **Redis** | 特征缓存、用户画像 | 高性能KV存储 |
| **MySQL** | 广告元数据、配置 | 关系型数据 |
| **HDFS** | 日志存储 | 海量数据 |
| **Hive** | 离线分析 | SQL查询 |
| **ES** | 广告检索 | 全文搜索 |

### **计算层**

| 组件 | 用途 | 特点 |
|-----|------|-----|
| **Spark** | 批量计算 | 用户画像、模型训练 |
| **Flink** | 实时计算 | 实时特征、实时报表 |
| **TensorFlow** | 深度学习 | CTR模型训练/推理 |

### **服务层**

| 组件 | 用途 | 特点 |
|-----|------|-----|
| **Nginx** | 负载均衡 | 高并发 |
| **gRPC** | 服务通信 | 高性能RPC |
| **Kubernetes** | 容器编排 | 弹性扩缩容 |

---

## 📈 关键指标监控

### **系统监控指标**

```
┌─────────────────────────────────────────────────────────────────┐
│                    系统监控大盘                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   流量指标                                                       │
│   ├── QPS：当前每秒请求数                                        │
│   ├── 成功率：请求成功比例                                       │
│   └── 延迟：P50/P95/P99延迟                                     │
│                                                                 │
│   业务指标                                                       │
│   ├── 填充率：有广告返回的比例                                   │
│   ├── CTR：点击率                                               │
│   └── eCPM：千次展示收入                                        │
│                                                                 │
│   资源指标                                                       │
│   ├── CPU使用率                                                 │
│   ├── 内存使用率                                                │
│   └── 网络带宽                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### **告警规则**

| 告警项 | 阈值 | 级别 |
|-------|-----|-----|
| 成功率下降 | <99% | P1 |
| P99延迟上升 | >200ms | P1 |
| 填充率下降 | 环比-10% | P2 |
| CTR异常 | 环比变化>20% | P2 |

---

## 🔒 反作弊系统

### **作弊类型**

```
┌─────────────────────────────────────────────────────────────────┐
│                    广告作弊类型                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   展示作弊                                                       │
│   ├── 虚假展示：机器生成的假流量                                 │
│   ├── 隐藏展示：1x1像素或不可见                                 │
│   └── 堆叠展示：多个广告叠在一起                                 │
│                                                                 │
│   点击作弊                                                       │
│   ├── 机器点击：脚本或机器人点击                                 │
│   ├── 误点诱导：故意设计的误点击                                 │
│   └── 刷量作弊：有组织的人工刷量                                 │
│                                                                 │
│   转化作弊                                                       │
│   ├── 虚假注册                                                  │
│   ├── 虚假下载                                                  │
│   └── 归因劫持                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### **反作弊策略**

```
反作弊多层防御：

Layer 1: 规则过滤
         ├── IP黑名单
         ├── 设备黑名单
         └── 频次限制

Layer 2: 特征检测
         ├── 点击位置分布异常
         ├── 点击时间模式异常
         └── 设备指纹异常

Layer 3: 机器学习模型
         ├── 异常检测模型
         └── 作弊分类模型

Layer 4: 人工审核
         └── 可疑流量人工复核
```

---

## 📱 广告SDK

### **SDK功能**

```
┌─────────────────────────────────────────────────────────────────┐
│                    广告SDK功能                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   广告请求                                                       │
│   ├── 向广告服务器发送请求                                       │
│   ├── 携带设备信息、用户标识                                     │
│   └── 处理请求超时和重试                                        │
│                                                                 │
│   广告展示                                                       │
│   ├── 渲染广告创意                                              │
│   ├── 支持多种广告形式                                          │
│   └── 可视性检测                                                │
│                                                                 │
│   事件追踪                                                       │
│   ├── 展示事件上报                                              │
│   ├── 点击事件上报                                              │
│   └── 转化事件上报                                              │
│                                                                 │
│   隐私合规                                                       │
│   ├── GDPR合规                                                  │
│   ├── CCPA合规                                                  │
│   └── ATT合规（iOS）                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎓 本章小结

### **核心要点**

1. **分层架构**：在线服务层、数据存储层、离线计算层
2. **核心模块**：广告检索、CTR预估、竞价排序
3. **数据流**：在线实时处理+离线批量计算
4. **关键挑战**：高并发、低延迟、大数据

### **技术栈总结**

```
┌─────────────────────────────────────────────────────────────────┐
│                    广告系统技术栈                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   在线服务: Nginx + gRPC + TensorFlow Serving                   │
│   缓存存储: Redis + Memcached                                   │
│   持久存储: MySQL + HDFS + Hive                                 │
│   消息队列: Kafka                                               │
│   批量计算: Spark                                               │
│   实时计算: Flink                                               │
│   搜索引擎: Elasticsearch                                       │
│   容器编排: Kubernetes                                          │
│   监控告警: Prometheus + Grafana                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### **思考题**

1. 如何在100ms内完成广告请求的处理？
2. 如何实现模型的热更新？
3. 如何设计一个高可用的广告系统？

---

## 📚 延伸阅读

- [07_点击率预测](./07_点击率预测.md) - 了解CTR模型
- [04_程序化交易广告](./04_程序化交易广告.md) - 了解RTB流程
- [01_计算广告基础](./01_计算广告基础.md) - 回顾基础概念

---

*下一章：[术语速查](./09_术语速查.md)*

